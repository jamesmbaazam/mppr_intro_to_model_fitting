<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-09-02">

<title>Fitting epidemics models in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="model_fitting_practicals_files/libs/clipboard/clipboard.min.js"></script>
<script src="model_fitting_practicals_files/libs/quarto-html/quarto.js"></script>
<script src="model_fitting_practicals_files/libs/quarto-html/popper.min.js"></script>
<script src="model_fitting_practicals_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="model_fitting_practicals_files/libs/quarto-html/anchor.min.js"></script>
<link href="model_fitting_practicals_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="model_fitting_practicals_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="model_fitting_practicals_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="model_fitting_practicals_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="model_fitting_practicals_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="model_fitting_practicals_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="model_fitting_practicals_files/libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fitting epidemics models in R</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 2, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="learning-objectives" class="level2">
<h2 class="anchored" data-anchor-id="learning-objectives">Learning Objectives</h2>
<p>By the end of this tutorial, you will be able to:</p>
<ul>
<li>Understand the basic principles of the SIR epidemic model and its parameters</li>
<li>Fit epidemic models to data using least squares estimation</li>
<li>Fit epidemic models using maximum likelihood estimation</li>
<li>Interpret model parameters in biological and epidemiological terms</li>
<li>Assess model fit and parameter uncertainty</li>
<li>Apply these methods to real outbreak data</li>
</ul>
</section>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>This tutorial assumes familiarity with:</p>
<ul>
<li>Basic R programming (data manipulation, plotting, functions)</li>
<li>Elementary statistics (probability distributions, optimization)</li>
<li>Basic calculus (understanding of derivatives and differential equations)</li>
</ul>
<p><strong>Required R packages:</strong></p>
</section>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this tutorial, we will fit a deterministic SIR model to data on an outbreak of flu in a British boarding school. The SIR model is one of the most fundamental models in mathematical epidemiology, describing how infectious diseases spread through a population.</p>
<section id="the-sir-model-a-brief-overview" class="level3">
<h3 class="anchored" data-anchor-id="the-sir-model-a-brief-overview">The SIR Model: A Brief Overview</h3>
<p>The SIR model divides a population into three compartments:</p>
<ul>
<li><strong>S</strong> (Susceptible): Individuals who can become infected</li>
<li><strong>I</strong> (Infectious): Individuals who are currently infected and can transmit the disease</li>
<li><strong>R</strong> (Recovered): Individuals who have recovered and are immune</li>
</ul>
<p>The model is described by a system of ordinary differential equations:</p>
<p><span class="math display">\[\frac{dS}{dt} = -\beta SI\]</span> <span class="math display">\[\frac{dI}{dt} = \beta SI - \gamma I\]</span> <span class="math display">\[\frac{dR}{dt} = \gamma I\]</span></p>
<p>Where:</p>
<ul>
<li><strong><span class="math inline">\(\beta\)</span> (beta)</strong> is the transmission rate: the rate at which susceptible individuals become infected per infected individual per unit time</li>
<li><strong><span class="math inline">\(\gamma\)</span> (gamma)</strong> is the recovery rate: the rate at which infected individuals recover (inverse of the infectious period)</li>
</ul>
</section>
<section id="key-epidemiological-quantities" class="level3">
<h3 class="anchored" data-anchor-id="key-epidemiological-quantities">Key Epidemiological Quantities</h3>
<p>From these parameters, we can derive important epidemiological quantities:</p>
<ul>
<li><strong>Basic reproduction number</strong>: <span class="math inline">\(R_0 = \frac{\beta}{\gamma}\)</span> - the average number of secondary infections caused by one infected individual in a fully susceptible population</li>
<li><strong>Effective reproduction number</strong>: <span class="math inline">\(R_t = R_0 \times \frac{S(t)}{N}\)</span> - the reproduction number at time <span class="math inline">\(t\)</span>, accounting for the proportion of susceptibles</li>
</ul>
</section>
<section id="the-data-1978-influenza-outbreak" class="level3">
<h3 class="anchored" data-anchor-id="the-data-1978-influenza-outbreak">The Data: 1978 Influenza Outbreak</h3>
<p>Our data comes from a 1978 influenza outbreak at a British boarding school with 763 students. The outbreak lasted 14 days, with cases recorded daily. This dataset is particularly valuable because:</p>
<ul>
<li>The population is well-defined and closed (no births, deaths, or migration)</li>
<li>The outbreak was well-documented with daily case counts</li>
<li>The short duration makes it ideal for fitting simple epidemic models</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and prepare the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>flu <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"./data/influenza_england_1978_school.csv"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>flu <span class="ot">&lt;-</span> flu <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">day =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),  <span class="co"># Create day variable (1 to 14)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">flu =</span> <span class="fu">as.numeric</span>(in_bed)  <span class="co"># Convert cases to numeric</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the outbreak data</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span> </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Number of Cases"</span>, </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Influenza Outbreak at British Boarding School, 1978"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Daily number of students in bed with flu"</span>) <span class="sc">+</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-assumptions-and-limitations" class="level3">
<h3 class="anchored" data-anchor-id="model-assumptions-and-limitations">Model Assumptions and Limitations</h3>
<p>Before fitting the model, it’s important to understand the assumptions we’re making:</p>
<p><strong>SIR Model Assumptions:</strong> - <strong>Homogeneous mixing</strong>: All individuals have equal probability of contact with each other - <strong>Constant population</strong>: No births, deaths, or migration during the outbreak - <strong>Perfect immunity</strong>: Recovered individuals cannot be reinfected - <strong>No latent period</strong>: Individuals become infectious immediately upon infection - <strong>Constant parameters</strong>: <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> do not change over time</p>
<p><strong>Data Assumptions:</strong> - <strong>Perfect reporting</strong>: All cases are observed and reported - <strong>Immediate detection</strong>: Cases are detected as soon as they become symptomatic - <strong>No asymptomatic cases</strong>: All infections result in observable symptoms</p>
<p>These assumptions may not hold perfectly in reality, but they provide a useful starting point for model fitting.</p>
</section>
</section>
<section id="fitting-continuous-time-models-to-data-trajectory-matching-with-least-squares" class="level2">
<h2 class="anchored" data-anchor-id="fitting-continuous-time-models-to-data-trajectory-matching-with-least-squares">Fitting continuous-time models to data: trajectory matching with least squares</h2>
<p>We start with one of the simplest approaches: least squares estimation. This method finds parameter values that minimize the sum of squared differences between observed data and model predictions.</p>
<section id="understanding-least-squares" class="level3">
<h3 class="anchored" data-anchor-id="understanding-least-squares">Understanding Least Squares</h3>
<p><strong>What is least squares?</strong> Least squares assumes that the only source of variability is measurement error, which is:</p>
<ul>
<li>Symmetrically distributed around the true value</li>
<li>Has constant variance (homoscedastic)</li>
<li>Is independent between observations</li>
</ul>
<p>Under these assumptions, least squares provides:</p>
<ul>
<li><strong>Unbiased estimates</strong> of model parameters</li>
<li><strong>Minimum variance</strong> among all unbiased estimators</li>
<li><strong>Maximum likelihood estimates</strong> when errors are normally distributed</li>
</ul>
<p><strong>Why use least squares?</strong></p>
<ul>
<li><strong>Getting initial values</strong>: Provides good starting points for more sophisticated methods</li>
<li><strong>Discovering deviations</strong>: Residuals can reveal model inadequacies</li>
<li><strong>Computational simplicity</strong>: Easy to implement and understand</li>
<li><strong>Robustness</strong>: Works reasonably well even when assumptions are slightly violated</li>
</ul>
</section>
<section id="defining-the-sir-model" class="level3">
<h3 class="anchored" data-anchor-id="defining-the-sir-model">Defining the SIR Model</h3>
<p>Let’s define the SIR model as a system of ordinary differential equations:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the SIR model as a function for deSolve</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, y, params) {</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(y, params)), {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rate of change of susceptible individuals</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> <span class="sc">-</span>beta <span class="sc">*</span> S <span class="sc">*</span> I</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rate of change of infectious individuals  </span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span>  beta <span class="sc">*</span> S <span class="sc">*</span> I <span class="sc">-</span> gamma <span class="sc">*</span> I</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rate of change of recovered individuals</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span>  gamma <span class="sc">*</span> I</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return the derivatives as a list</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS, dI, dR))</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-the-objective-function" class="level3">
<h3 class="anchored" data-anchor-id="creating-the-objective-function">Creating the Objective Function</h3>
<p>Now we set up a function that calculates the sum of squared differences between the observations and the model predictions. This is our objective function that we want to minimize.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the deSolve package for solving differential equations</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the sum of squared errors function</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>sse_sir <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract data and parameters</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> data<span class="sc">$</span>day        <span class="co"># Time points for simulation</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  cases <span class="ot">&lt;-</span> data<span class="sc">$</span>flu     <span class="co"># Observed case counts</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">&lt;-</span> params0[<span class="dv">1</span>]    <span class="co"># Transmission rate parameter</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  gamma <span class="ot">&lt;-</span> params0[<span class="dv">2</span>]   <span class="co"># Recovery rate parameter</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Initial conditions (based on the boarding school population)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  S0 <span class="ot">&lt;-</span> <span class="dv">762</span>  <span class="co"># Initial number of susceptibles (total population - 1)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  I0 <span class="ot">&lt;-</span> <span class="dv">1</span>     <span class="co"># Initial number of infectious (index case)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  R0 <span class="ot">&lt;-</span> <span class="dv">0</span>     <span class="co"># Initial number of recovered</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> S0, <span class="at">I =</span> I0, <span class="at">R =</span> R0)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate the SIR model using ode()</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">ode</span>(<span class="at">y =</span> init,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">times =</span> dt,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">func =</span> sir_model,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">parms =</span> <span class="fu">c</span>(<span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">hmax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">120</span>  <span class="co"># Maximum step size for numerical integration</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert output to data frame for easier manipulation</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(out)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate sum of squared errors between model predictions and observations</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  sse <span class="ot">&lt;-</span> <span class="fu">sum</span>((out<span class="sc">$</span>I <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(sse)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Key points about this function:</strong></p>
<ul>
<li><strong>Initial conditions</strong>: We assume 762 susceptibles, 1 infectious individual (the index case), and 0 recovered</li>
<li><strong>Time points</strong>: We simulate the model at the same time points where we have observations</li>
<li><strong>Numerical integration</strong>: The <code>hmax = 1/120</code> parameter controls the step size for solving the differential equations</li>
<li><strong>Objective function</strong>: We return the sum of squared errors, which we want to minimize</li>
</ul>
</section>
<section id="exploring-parameter-space" class="level3">
<h3 class="anchored" data-anchor-id="exploring-parameter-space">Exploring Parameter Space</h3>
<p>Now, let’s see how this function works by exploring different parameter values.</p>
<p>To start, we’ll fix <span class="math inline">\(\gamma\)</span> (the recovery rate) and explore different values of <span class="math inline">\(\beta\)</span> (the transmission rate).</p>
<p><strong>Why fix <span class="math inline">\(\gamma\)</span> first?</strong> Individuals infected with flu typically are infectious for roughly 1 day prior to presenting with symptoms. In this case, we may suspect that sick individuals were immediately removed from interacting with susceptible individuals as soon as they were detected. Therefore, for current purposes we assume <span class="math inline">\(\gamma = 1\)</span> (meaning the infectious period is 1 day).</p>
<p><strong>Exploring the objective function:</strong></p>
<p>We’ll create a grid of parameter values and evaluate our objective function at each point. This will help us understand:</p>
<ul>
<li>The shape of the objective function</li>
<li>Where the minimum might be located</li>
<li>Whether there are multiple local minima</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame to store parameter combinations and their SSE values</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sse_example <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta  =</span> <span class="dv">1</span> <span class="sc">*</span> <span class="dv">10</span><span class="sc">^-</span><span class="fu">seq</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">20</span>),  <span class="co"># $\beta$ values from 0.01 to 0.001</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">gamma =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="dv">20</span>),  <span class="co"># Fixed $\gamma = 1$</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">sse =</span> <span class="cn">NA</span>  <span class="co"># Initialize SSE column</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate SSE for each parameter combination</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sse_example)) {</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  sse_example<span class="sc">$</span>sse[i] <span class="ot">&lt;-</span> <span class="fu">sse_sir</span>(<span class="fu">as.numeric</span>(sse_example[i, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]), <span class="at">data =</span> flu)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the objective function</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> sse_example, <span class="fu">aes</span>(<span class="at">x =</span> beta, <span class="at">y =</span> sse)) <span class="sc">+</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>() <span class="sc">+</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">label_comma</span>()) <span class="sc">+</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">expression</span>(beta), <span class="at">y =</span> <span class="st">"Sum of Squared Errors"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Objective Function: SSE vs Transmission Rate"</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Fixed recovery rate gamma = 1"</span>) <span class="sc">+</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpreting-the-results" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-results">Interpreting the Results</h3>
<p>From the plot, we can see that there is a clear minimum in the sum of squared errors, indicating that there is an optimal value of <span class="math inline">\(\beta\)</span> that best fits our data.</p>
<p><strong>Key observations:</strong></p>
<ul>
<li>The SSE decreases as <span class="math inline">\(\beta\)</span> increases from very small values</li>
<li>There’s a clear minimum around <span class="math inline">\(\hat{\beta} \approx 0.003\)</span></li>
<li>The function is well-behaved (smooth, single minimum)</li>
</ul>
<p><strong>Limitations of this approach:</strong> 1. <strong>Imprecise location</strong>: The exact location of the minimum isn’t precisely determined from this grid search 2. <strong>Fixed <span class="math inline">\(\gamma\)</span> assumption</strong>: Our estimate is only valid if <span class="math inline">\(\gamma = 1\)</span> is correct, but this was just an approximation</p>
</section>
<section id="moving-to-numerical-optimization" class="level3">
<h3 class="anchored" data-anchor-id="moving-to-numerical-optimization">Moving to Numerical Optimization</h3>
<p>To solve these problems, we need to: 1. <strong>Fit both parameters simultaneously</strong>: Find the minimum of a 2D surface in (<span class="math inline">\(\beta\)</span>, <span class="math inline">\(\gamma\)</span>) space 2. <strong>Use numerical optimization</strong>: Employ algorithms that can find precise minima</p>
<p>This process is called <strong>optimization</strong>, and R provides robust algorithms for this purpose. The <code>optim()</code> function uses the Nelder-Mead algorithm by default, which is well-suited for this type of problem.</p>
</section>
<section id="using-the-optim-function" class="level3">
<h3 class="anchored" data-anchor-id="using-the-optim-function">Using the optim() Function</h3>
<p>Let’s examine the <code>optim()</code> function and then use it to find the best fit parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at the help file for optim()</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>?optim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Key arguments of <code>optim()</code>:</strong></p>
<ul>
<li><code>par</code>: Initial values for the parameters to be optimized</li>
<li><code>fn</code>: The function to be minimized (our SSE function)</li>
<li><code>data</code>: Additional data to pass to the function</li>
<li><code>method</code>: The optimization algorithm to use (default is “Nelder-Mead”)</li>
</ul>
<p><strong>Why run optim() twice?</strong></p>
<p>We run the optimization twice to ensure convergence to the global minimum:</p>
<ol type="1">
<li>First run: Uses our initial guess</li>
<li>Second run: Uses the result from the first run as the starting point</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set initial parameter values ($\beta$, $\gamma$)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>params0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.5</span>)  <span class="co"># Initial guess: $\beta = 0.001$, $\gamma = 0.5$</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># First optimization run</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">optim</span>(params0, sse_sir, <span class="at">data =</span> flu)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"First optimization result:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "First optimization result:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit0<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002580105 0.471936440</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Second optimization run using first result as starting point</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">optim</span>(fit0<span class="sc">$</span>par, sse_sir, <span class="at">data =</span> flu)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Final optimization result:"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Final optimization result:"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fit1<span class="sc">$</span>par)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002579972 0.471932750</code></pre>
</div>
</div>
</section>
<section id="visualizing-the-fitted-model" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-the-fitted-model">Visualizing the Fitted Model</h3>
<p>Now let’s simulate the model with our best-fit parameters and compare it to the observed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create fine time grid for smooth model simulation</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">max</span>(flu<span class="sc">$</span>day), <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate model with best fit parameters</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>model_sim <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">762</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>),  <span class="co"># Initial conditions</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> dt,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">func =</span> sir_model,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">parms =</span> <span class="fu">c</span>(<span class="at">beta =</span> fit1<span class="sc">$</span>par[<span class="dv">1</span>], <span class="at">gamma =</span> fit1<span class="sc">$</span>par[<span class="dv">2</span>]),  <span class="co"># Best fit parameters</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">hmax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">120</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame for plotting</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>model_sim <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(model_sim)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the fitted model against the data</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> model_sim, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> I), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Number of Cases"</span>,</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"SIR Model Fit to Influenza Data"</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"$</span><span class="sc">\\</span><span class="st">beta =$"</span>, <span class="fu">round</span>(fit1<span class="sc">$</span>par[<span class="dv">1</span>], <span class="dv">4</span>), <span class="st">", $</span><span class="sc">\\</span><span class="st">gamma =$"</span>, <span class="fu">round</span>(fit1<span class="sc">$</span>par[<span class="dv">2</span>], <span class="dv">4</span>))) <span class="sc">+</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="interpreting-the-results-1" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-results-1">Interpreting the Results</h3>
<p><strong>Parameter estimates:</strong></p>
<ul>
<li><strong><span class="math inline">\(\beta\)</span> (transmission rate)</strong>: 0.0026 per day</li>
<li><strong><span class="math inline">\(\gamma\)</span> (recovery rate)</strong>: 0.4719 per day</li>
</ul>
<p><strong>Biological interpretation:</strong></p>
<ul>
<li><strong>Infectious period</strong>: 2.1 days (1/<span class="math inline">\(\gamma\)</span>)</li>
<li><strong>Basic reproduction number</strong>: <span class="math inline">\(R_0 = \beta/\gamma =\)</span> 0.01</li>
<li><strong>Model fit</strong>: The red line shows how well our fitted SIR model captures the observed epidemic curve</li>
</ul>
</section>
<section id="limitations-of-least-squares" class="level3">
<h3 class="anchored" data-anchor-id="limitations-of-least-squares">Limitations of Least Squares</h3>
<p>While least squares is a useful starting point, it has several limitations:</p>
<p><strong>Statistical limitations:</strong></p>
<ul>
<li><strong>Arbitrary objective function</strong>: Why minimize squared errors rather than absolute errors or other measures?</li>
<li><strong>No uncertainty quantification</strong>: We get point estimates but no confidence intervals or measures of parameter uncertainty</li>
<li><strong>Assumption violations</strong>: Real data often don’t meet the assumptions of constant variance and normal errors</li>
</ul>
<p><strong>Practical limitations:</strong></p>
<ul>
<li><strong>Parameter identifiability</strong>: Multiple parameter combinations may produce similar model fits</li>
<li><strong>Sensitivity to outliers</strong>: A few extreme observations can strongly influence the fit</li>
<li><strong>No probabilistic framework</strong>: Doesn’t provide a statistical framework for model comparison</li>
</ul>
<p><strong>When least squares is appropriate:</strong></p>
<ul>
<li>Getting initial parameter estimates for more sophisticated methods</li>
<li>Quick exploratory analysis</li>
<li>When measurement error is the primary source of variability</li>
<li>When computational simplicity is important</li>
</ul>
<p>In the next section, we’ll explore maximum likelihood estimation, which addresses many of these limitations by providing a principled statistical framework.</p>
</section>
</section>
<section id="exercises-least-squares-estimation" class="level2">
<h2 class="anchored" data-anchor-id="exercises-least-squares-estimation">Exercises: Least Squares Estimation</h2>
<section id="exercise-1-parameter-sensitivity-analysis" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1-parameter-sensitivity-analysis">Exercise 1: Parameter Sensitivity Analysis</h3>
<ul>
<li><p>How do the fitted parameters change when you assume different numbers of initial infectious individuals? What does this tell you about the importance of knowing initial conditions?</p></li>
<li><p>Fix <span class="math inline">\(\gamma\)</span> at different values (0.5, 1.0, 1.5) and refit <span class="math inline">\(\beta\)</span>. How does this affect the estimated transmission rate?</p></li>
<li><p>Try different initial parameter values for <code>optim()</code>. Do you always get the same solution? What does this tell you about the optimization routine?</p></li>
<li><p>Calculate residuals (observed - predicted) for the fitted model. Plot residuals vs.&nbsp;time. Are there any patterns that suggest model inadequacy?</p></li>
<li><p>Fit the model to log-transformed case counts. How does this change the parameter estimates? What are the trade-offs of this approach?</p></li>
</ul>
</section>
</section>
<section id="fitting-continuous-time-models-to-data-trajectory-matching-with-maximum-likelihood" class="level2">
<h2 class="anchored" data-anchor-id="fitting-continuous-time-models-to-data-trajectory-matching-with-maximum-likelihood">Fitting continuous-time models to data: trajectory matching with Maximum Likelihood</h2>
<p>Maximum likelihood estimation (MLE) provides a more principled and robust approach to fitting models to data than least squares. It’s based on a probabilistic framework that allows us to quantify uncertainty and make statistical inferences.</p>
<section id="understanding-maximum-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="understanding-maximum-likelihood">Understanding Maximum Likelihood</h3>
<p><strong>What is maximum likelihood?</strong> Maximum likelihood finds the parameter values that make the observed data most probable under the assumed model. It’s based on the likelihood function:</p>
<p><span class="math display">\[L(\theta) = \prod_{i=1}^{n} f(y_i | \theta)\]</span></p>
<p>Where: - <span class="math inline">\(L(\theta)\)</span> is the likelihood function - <span class="math inline">\(\theta\)</span> represents the model parameters - <span class="math inline">\(f(y_i | \theta)\)</span> is the probability density function for observation <span class="math inline">\(i\)</span> - The product is over all <span class="math inline">\(n\)</span> observations</p>
<p><strong>Why use maximum likelihood?</strong></p>
<ul>
<li><strong>Principled approach</strong>: Based on probability theory and statistical inference</li>
<li><strong>Uncertainty quantification</strong>: Provides confidence intervals and standard errors</li>
<li><strong>Model comparison</strong>: Enables formal statistical tests between models</li>
<li><strong>Flexibility</strong>: Can incorporate different probability distributions for the data</li>
</ul>
</section>
<section id="steps-in-maximum-likelihood-estimation" class="level3">
<h3 class="anchored" data-anchor-id="steps-in-maximum-likelihood-estimation">Steps in Maximum Likelihood Estimation</h3>
<ol type="1">
<li><strong>Specify the probability distribution</strong> for the observations</li>
<li><strong>Write the likelihood function</strong> as a function of model parameters</li>
<li><strong>Take the log</strong> and negate to get the negative log-likelihood (easier to work with)</li>
<li><strong>Minimize the negative log-likelihood</strong> using numerical optimization</li>
<li><strong>Extract parameter estimates</strong> and their uncertainties</li>
</ol>
</section>
<section id="choosing-a-probability-distribution" class="level3">
<h3 class="anchored" data-anchor-id="choosing-a-probability-distribution">Choosing a Probability Distribution</h3>
<p>For our epidemic data, we need to specify how the observed case counts are distributed around the model predictions. We’ll assume the observations follow a <strong>Poisson distribution</strong>, which is appropriate for count data.</p>
<p><strong>Why Poisson distribution?</strong></p>
<ul>
<li><strong>Count data</strong>: We’re observing discrete numbers of cases</li>
<li><strong>Variance scaling</strong>: The variance increases with the mean (realistic for epidemic data)</li>
<li><strong>Non-negative</strong>: Poisson only produces non-negative values</li>
<li><strong>Simple</strong>: Has only one parameter (the mean)</li>
</ul>
<p><strong>Parameter transformation:</strong></p>
<p>Since <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> must be positive, we’ll use log-transformed parameters:</p>
<ul>
<li><span class="math inline">\(\beta = e^b\)</span> where <span class="math inline">\(b\)</span> can be any real number</li>
<li><span class="math inline">\(\gamma = e^g\)</span> where <span class="math inline">\(g\)</span> can be any real number</li>
</ul>
<p>This transformation helps numerical optimization algorithms work more effectively.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The Poisson assumption means we’re modeling the observed case counts as: <span class="math display">\[Y_i \sim \text{Poisson}(\lambda_i)\]</span> where <span class="math inline">\(\lambda_i\)</span> is the model prediction for time <span class="math inline">\(i\)</span>. This accounts for the natural variability in case reporting and the discrete nature of the data.</p>
</div>
</div>
<p>First, let’s write a function to simulate the model given some combination of parameters. This is the same function we used in the least squares approach.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x, params) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(x, params)), {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> <span class="sc">-</span>beta<span class="sc">*</span>S<span class="sc">*</span>I</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span> beta<span class="sc">*</span>S<span class="sc">*</span>I <span class="sc">-</span> gamma<span class="sc">*</span>I</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span> gamma<span class="sc">*</span>I</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS, dI, dR))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s write a function to return the negative log-likelihood of the data, given some combination of parameters. We will use the <code>dpois</code> function from the <code>stats</code> package to calculate the Poisson likelihood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>sir_nll <span class="ot">&lt;-</span> <span class="cf">function</span>(b) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">14</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">exp</span>(b), <span class="at">gamma =</span> <span class="fl">0.75</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">762</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ode</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> init,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">times =</span> dt,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">func =</span> sir_model,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">parms =</span> parms,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">hmax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">120</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate negative log-likelihood.</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="at">x =</span> flu<span class="sc">$</span>flu, <span class="at">lambda =</span> <span class="fu">tail</span>(out<span class="sc">$</span>I, <span class="fu">nrow</span>(flu)), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using <code>mle2</code> we fit the model (according to the likelihood criterion).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>params0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">b =</span> <span class="sc">-</span><span class="dv">6</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">mle2</span>(sir_nll, <span class="at">start =</span> params0)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>fit0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mle2(minuslogl = sir_nll, start = params0)

Coefficients:
        b 
-6.031951 

Log-likelihood: -272.41 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">mle2</span>(sir_nll, <span class="at">start =</span> <span class="fu">as.list</span>(<span class="fu">coef</span>(fit0)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mle2(minuslogl = sir_nll, start = as.list(coef(fit0)))

Coefficients:
        b 
-6.031946 

Log-likelihood: -272.41 </code></pre>
</div>
</div>
</section>
<section id="exploring-the-likelihood" class="level3">
<h3 class="anchored" data-anchor-id="exploring-the-likelihood">Exploring the likelihood</h3>
<p>We can get an idea about the uncertainty and in particular obtain confidence intervals using the profile likelihood. In <code>bbmle</code>, we can do this using the <code>profile</code> function. The <code>absVal = TRUE</code> argument ensures that the plot is on the absolute scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">profile</span>(fit)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, <span class="at">absVal =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>How does this model look when plotted against the data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(deSolve)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(flu<span class="sc">$</span>day), <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">unname</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit))), <span class="at">gamma =</span> <span class="fl">0.75</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">762</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate model</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>mod_pred <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> init,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> dt,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">func =</span> sir_model,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">parms =</span> parms,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">hmax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">120</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>mod_pred <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(mod_pred)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the fitted model against the data</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> mod_pred, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> I), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Cases"</span>) <span class="sc">+</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Recalling that we obtained our parameter <span class="math inline">\(b\)</span> (and therefore the transmission rate <span class="math inline">\(\beta\)</span>) assuming a particular value of <span class="math inline">\(\gamma\)</span>, we wonder now how good this assumption was. Indeed, it is not hard to extend our approach to estimate <span class="math inline">\(b\)</span> and <span class="math inline">\(g\)</span> simultaneously, as follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>sir_model <span class="ot">&lt;-</span> <span class="cf">function</span>(t, x, params) {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">with</span>(<span class="fu">as.list</span>(<span class="fu">c</span>(x, params)), {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    dS <span class="ot">&lt;-</span> <span class="sc">-</span>beta<span class="sc">*</span>S<span class="sc">*</span>I</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    dI <span class="ot">&lt;-</span> beta<span class="sc">*</span>S<span class="sc">*</span>I <span class="sc">-</span> gamma<span class="sc">*</span>I</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    dR <span class="ot">&lt;-</span> gamma<span class="sc">*</span>I</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="fu">c</span>(dS, dI, dR))</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Negative log-likelihood function</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>sir_nll <span class="ot">&lt;-</span> <span class="cf">function</span>(b, g){</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">14</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">exp</span>(b), <span class="at">gamma =</span> <span class="fu">exp</span>(g)) <span class="co"># Exponentiate to get $\beta$ and $\gamma$</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">762</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Simulate model</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> init,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">times =</span> dt,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">func =</span> sir_model,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">parms =</span> parms</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to data frame</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(out)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate negative log-likelihood.</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  nll <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">sum</span>(<span class="fu">dpois</span>(<span class="at">x =</span> flu<span class="sc">$</span>flu, <span class="at">lambda =</span> <span class="fu">tail</span>(out<span class="sc">$</span>I, <span class="fu">nrow</span>(flu)), <span class="at">log =</span> <span class="cn">TRUE</span>))</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, we pick some initial values and fit.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bbmle)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>params0 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">b =</span> <span class="sc">-</span><span class="dv">6</span>, <span class="at">g =</span> <span class="sc">-</span><span class="fl">0.7</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">mle2</span>(sir_nll, <span class="at">start =</span> params0)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>fit0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mle2(minuslogl = sir_nll, start = params0)

Coefficients:
         b          g 
-6.1128649 -0.7421043 

Log-likelihood: -76.29 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use previous fit as starting values</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">mle2</span>(sir_nll, <span class="at">start =</span> <span class="fu">as.list</span>(<span class="fu">coef</span>(fit0)))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
mle2(minuslogl = sir_nll, start = as.list(coef(fit0)))

Coefficients:
         b          g 
-6.1128649 -0.7421043 

Log-likelihood: -76.29 </code></pre>
</div>
</div>
<p>We can now visualise the likelihood profiles</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">profile</span>(fit)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(p, <span class="at">absVal =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can plot the fitted model against the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(flu<span class="sc">$</span>day), <span class="at">by =</span> <span class="fl">0.05</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>parms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">beta =</span> <span class="fu">unname</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">1</span>])), <span class="at">gamma =</span> <span class="fu">unname</span>(<span class="fu">exp</span>(<span class="fu">coef</span>(fit)[<span class="dv">2</span>])))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> <span class="dv">762</span>, <span class="at">I =</span> <span class="dv">1</span>, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate model</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>mod_pred <span class="ot">&lt;-</span> <span class="fu">ode</span>(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> init,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">times =</span> dt,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">func =</span> sir_model,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">parms =</span> parms</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to data frame</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>mod_pred <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(mod_pred)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the fitted model against the data</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> flu, <span class="fu">aes</span>(<span class="at">x =</span> day, <span class="at">y =</span> flu)) <span class="sc">+</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> mod_pred, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> I), <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Day"</span>, <span class="at">y =</span> <span class="st">"Cases"</span>) <span class="sc">+</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="model_fitting_practicals_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="practical-considerations-and-troubleshooting" class="level2">
<h2 class="anchored" data-anchor-id="practical-considerations-and-troubleshooting">Practical Considerations and Troubleshooting</h2>
<section id="common-issues-and-solutions" class="level3">
<h3 class="anchored" data-anchor-id="common-issues-and-solutions">Common Issues and Solutions</h3>
<p><strong>Optimization convergence problems:</strong></p>
<ul>
<li><strong>Issue</strong>: <code>optim()</code> or <code>mle2()</code> fails to converge</li>
<li><strong>Solutions</strong>:
<ul>
<li>Try different initial values</li>
<li>Use different optimization methods</li>
<li>Check for parameter bounds or constraints</li>
<li>Verify the objective function is well-behaved</li>
</ul></li>
</ul>
<p><strong>Parameter identifiability:</strong></p>
<ul>
<li><strong>Issue</strong>: Multiple parameter combinations give similar fits</li>
<li><strong>Solutions</strong>:
<ul>
<li>Use profile likelihood to assess parameter correlations</li>
<li>Consider fixing one parameter based on external information</li>
<li>Collect more data or different types of data</li>
</ul></li>
</ul>
<p><strong>Model validation:</strong></p>
<ul>
<li><strong>Residual analysis</strong>: Check if residuals show patterns</li>
<li><strong>Goodness of fit</strong>: Compare AIC/BIC for different models</li>
<li><strong>Sensitivity analysis</strong>: Test robustness to initial conditions</li>
</ul>
</section>
<section id="sensitivity-to-initial-conditions" class="level3">
<h3 class="anchored" data-anchor-id="sensitivity-to-initial-conditions">Sensitivity to Initial Conditions</h3>
<p>The fitted parameters can be sensitive to assumptions about initial conditions. Let’s explore this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test sensitivity to initial infectious individuals</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>test_I0 <span class="ot">&lt;-</span> <span class="cf">function</span>(I0_vals) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">I0 =</span> I0_vals, <span class="at">beta =</span> <span class="cn">NA</span>, <span class="at">gamma =</span> <span class="cn">NA</span>, <span class="at">sse =</span> <span class="cn">NA</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(I0_vals)) {</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Modify the SSE function to use different I0</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    sse_sir_test <span class="ot">&lt;-</span> <span class="cf">function</span>(params0, data, I0_val) {</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      dt <span class="ot">&lt;-</span> data<span class="sc">$</span>day</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      cases <span class="ot">&lt;-</span> data<span class="sc">$</span>flu</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      beta <span class="ot">&lt;-</span> params0[<span class="dv">1</span>]</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      gamma <span class="ot">&lt;-</span> params0[<span class="dv">2</span>]</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>      S0 <span class="ot">&lt;-</span> <span class="dv">763</span> <span class="sc">-</span> I0_val  <span class="co"># Adjust S0 to maintain total population</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>      init <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">S =</span> S0, <span class="at">I =</span> I0_val, <span class="at">R =</span> <span class="dv">0</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> <span class="fu">ode</span>(<span class="at">y =</span> init, <span class="at">times =</span> dt, <span class="at">func =</span> sir_model,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">parms =</span> <span class="fu">c</span>(<span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma), <span class="at">hmax =</span> <span class="dv">1</span><span class="sc">/</span><span class="dv">120</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>      out <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(out)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>      sse <span class="ot">&lt;-</span> <span class="fu">sum</span>((out<span class="sc">$</span>I <span class="sc">-</span> cases)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(sse)</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit with different I0</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    fit_test <span class="ot">&lt;-</span> <span class="fu">optim</span>(<span class="fu">c</span>(<span class="fl">0.001</span>, <span class="fl">0.5</span>), sse_sir_test, <span class="at">data =</span> flu, <span class="at">I0_val =</span> I0_vals[i])</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    results[i, <span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>] <span class="ot">&lt;-</span> <span class="fu">c</span>(fit_test<span class="sc">$</span>par, fit_test<span class="sc">$</span>value)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Test different initial infectious values</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>I0_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">10</span>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>sensitivity_results <span class="ot">&lt;-</span> <span class="fu">test_I0</span>(I0_range)</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(sensitivity_results)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  I0        beta     gamma       sse
1  1 0.002580105 0.4719364  4562.005
2  2 0.002358144 0.4567664  3594.080
3  3 0.002227876 0.4468659  3874.361
4  5 0.002062333 0.4331912  5440.277
5 10 0.001833890 0.4122508 10543.486</code></pre>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this tutorial, we’ve learned how to:</p>
<ol type="1">
<li><strong>Fit epidemic models to data</strong> using both least squares and maximum likelihood methods</li>
<li><strong>Interpret model parameters</strong> in biological and epidemiological terms</li>
<li><strong>Assess model fit</strong> and parameter uncertainty</li>
<li><strong>Understand the assumptions</strong> underlying different fitting approaches</li>
<li><strong>Recognize limitations</strong> and practical considerations in model fitting</li>
</ol>
<section id="key-takeaways" class="level3">
<h3 class="anchored" data-anchor-id="key-takeaways">Key Takeaways</h3>
<ul>
<li><strong>Least squares</strong> is useful for initial exploration but has limitations for uncertainty quantification</li>
<li><strong>Maximum likelihood</strong> provides a principled framework with uncertainty estimates</li>
<li><strong>Parameter interpretation</strong> requires understanding both the mathematical model and biological context</li>
<li><strong>Model validation</strong> is crucial for assessing the reliability of fitted parameters</li>
<li><strong>Sensitivity analysis</strong> helps understand the robustness of results to assumptions</li>
</ul>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references">References</h3>
<ul>
<li>Ray Hilborn and Marc Mangel (1997). The Ecological Detective: Confronting Models with Data. Princeton University Press.</li>
<li>Keeling, M.J. and Rohani, P. (2008). Modeling Infectious Diseases in Humans and Animals. Princeton University Press.</li>
<li>Bolker, B. (2008). Ecological Models and Data in R. Princeton University Press.</li>
</ul>
</section>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises</h2>
<ul>
<li>How do the fitted parameters change when you assume different numbers of initial infectious individuals?
<ul>
<li>What does this tell you about the importance of knowing initial conditions?</li>
</ul></li>
<li>Fix <span class="math inline">\(\gamma\)</span> at different values (0.5, 1.0, 1.5) and refit <span class="math inline">\(\beta\)</span>
<ul>
<li>How does this affect the estimated transmission rate?</li>
</ul></li>
<li>Compare the parameter estimates from least squares vs.&nbsp;maximum likelihood. Which method gives more realistic parameter values?</li>
<li>Calculate residuals for both methods. Plot residuals vs.&nbsp;time to check for patterns. Which model fits better?</li>
<li>Try fitting with a negative binomial distribution instead of Poisson. How do the results change?</li>
<li>Fit an SEIR model (with exposed compartment) to the same data. Compare the fit to the SIR model.</li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>